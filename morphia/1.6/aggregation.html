<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Aggregation :: Morphia Docs</title>
    <meta name="generator" content="Antora 2.3.3">
<link rel="stylesheet" href="../../_/css/site.css">
<link rel="stylesheet" href="../../_/css/morphia.css">

  </head>
  <body class="article">
<header class="header" role="banner">
    <nav class="navbar">
        <div class="navbar-brand">
            <img height="80%" src="../../_/img/logo.png">
        </div>
        <div class="navbar-brand">
            <div class="navbar-item">
                <a href="https://morphia.dev">Morphia</a>
                <span class="separator">//</span>
                <a href="../..">Docs</a>
            </div>
            <button class="navbar-burger" data-target="topbar-nav">
                <span></span>
                <span></span>
                <span></span>
            </button>
        </div>
        <div id="topbar-nav" class="navbar-menu">
            <div class="navbar-end">
                <div class="navbar-item has-dropdown is-hoverable">
                    <div class="navbar-link">Projects</div>
                    <div class="navbar-dropdown">
                        <div class="navbar-item"><strong>Core</strong></div>
                        <a class="navbar-item" href="https://github.com/MorphiaOrg/morphia">Repository</a>
                        <a class="navbar-item" href="https://github.com/MorphiaOrg/morphia/issues">Issue Tracker</a>
                        <hr class="navbar-divider">
                        <div class="navbar-item"><strong>Critter</strong></div>
                        <a class="navbar-item" href="https://github.com/MorphiaOrg/critter">Repository</a>
                        <a class="navbar-item" href="https://github.com/MorphiaOrg/critter/issues">Issue Tracker</a>
                        <!--                        <hr class="navbar-divider">-->
                        <!--                        <a class="navbar-item" href="https://github.com/MorphiaOrg/morphia/blob/master/contributing.adoc">Contributing</a></div>-->
                    </div>
                </div>

                <div class="navbar-item has-dropdown is-hoverable">
                    <div class="navbar-link">Community</div>
                    <div class="navbar-dropdown is-right">
                        <a class="navbar-item" href="https://developer.mongodb.com/community/forums/c/drivers-odms/">Drivers &
                            ODMs chat</a>
                    </div>
                </div>

                <a class="navbar-item" href="https://twitter.com/evanchooly">
                    <span class="icon">
                        <svg aria-hidden="true" data-icon="twitter" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512">
                            <path fill="#57aaee"
                                  d="M459.37 151.716c.325 4.548.325 9.097.325 13.645 0 138.72-105.583 298.558-298.558 298.558-59.452 0-114.68-17.219-161.137-47.106 8.447.974 16.568 1.299 25.34 1.299 49.055 0 94.213-16.568 130.274-44.832-46.132-.975-84.792-31.188-98.112-72.772 6.498.974 12.995 1.624 19.818 1.624 9.421 0 18.843-1.3 27.614-3.573-48.081-9.747-84.143-51.98-84.143-102.985v-1.299c13.969 7.797 30.214 12.67 47.431 13.319-28.264-18.843-46.781-51.005-46.781-87.391 0-19.492 5.197-37.36 14.294-52.954 51.655 63.675 129.3 105.258 216.365 109.807-1.624-7.797-2.599-15.918-2.599-24.04 0-57.828 46.782-104.934 104.934-104.934 30.213 0 57.502 12.67 76.67 33.137 23.715-4.548 46.456-13.32 66.599-25.34-7.798 24.366-24.366 44.833-46.132 57.827 21.117-2.273 41.584-8.122 60.426-16.243-14.292 20.791-32.161 39.308-52.628 54.253z"></path>
                        </svg>
                    </span>
                </a>
            </div>
        </div>
    </nav>
</header>

<div class="body">
<div class="nav-container" data-component="morphia" data-version="1.6">
  <aside class="nav">
    <div class="panels">
<div class="nav-panel-menu is-active" data-panel="menu">
  <nav class="nav-menu">
    <h3 class="title"><a href="index.html">Morphia</a></h3>
<ul class="nav-list">
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="index.html">Getting Started</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="quick-tour.html">Quick Tour</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="migration.html">Migrating to 2.0</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="querying.html">Querying</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="updating.html">Updating</a>
  </li>
  <li class="nav-item is-current-page" data-depth="1">
    <a class="nav-link" href="aggregation.html">Aggregation</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="annotations.html">Annotations</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="indexing.html">Indexing</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="lifeCycleMethods.html">Life Cycle Methods</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="issues-help.html">Issues &amp; Support</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="jrebel.html">JRebel</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="validationExtension.html">Validation Extension</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="javadoc/index.html">Javadoc</a>
  </li>
</ul>
  </li>
</ul>
  </nav>
</div>
<div class="nav-panel-explore" data-panel="explore">
  <div class="context">
    <span class="title">Morphia</span>
    <span class="version">1.6</span>
  </div>
  <ul class="components">
    <li class="component">
      <span class="title">Critter</span>
      <ul class="versions">
        <li class="version">
          <a href="../../critter/4.2/index.html">4.2-SNAPSHOT</a>
        </li>
        <li class="version is-latest">
          <a href="../../critter/4.1/index.html">4.1</a>
        </li>
      </ul>
    </li>
    <li class="component">
      <span class="title">Home</span>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../../landing/index.html">landing</a>
        </li>
      </ul>
    </li>
    <li class="component is-current">
      <span class="title">Morphia</span>
      <ul class="versions">
        <li class="version">
          <a href="../2.3/index.html">2.3-SNAPSHOT</a>
        </li>
        <li class="version is-latest">
          <a href="../2.2/index.html">2.2</a>
        </li>
        <li class="version">
          <a href="../2.1/index.html">2.1</a>
        </li>
        <li class="version">
          <a href="../2.0/index.html">2.0</a>
        </li>
        <li class="version is-current">
          <a href="index.html">1.6</a>
        </li>
      </ul>
    </li>
  </ul>
</div>
    </div>
  </aside>
</div>
<main class="article">
<div class="toolbar" role="navigation">
<button class="nav-toggle"></button>
  <a href="../../landing/index.html" class="home-link"></a>
<nav class="breadcrumbs" aria-label="breadcrumbs">
  <ul>
    <li><a href="index.html">Morphia</a></li>
    <li><a href="aggregation.html">Aggregation</a></li>
  </ul>
</nav>
<div class="page-versions">
  <button class="version-menu-toggle" title="Show other versions of page">1.6</button>
  <div class="version-menu">
    <a class="version is-missing" href="../2.3/index.html">2.3-SNAPSHOT</a>
    <a class="version is-missing" href="../2.2/index.html">2.2</a>
    <a class="version" href="../2.1/aggregation.html">2.1</a>
    <a class="version" href="../2.0/aggregation.html">2.0</a>
    <a class="version is-current" href="aggregation.html">1.6</a>
  </div>
</div>
  <div class="edit-this-page"><a href="https://github.com/MorphiaOrg/morphia/edit/1.6.x/docs/modules/ROOT/pages/aggregation.adoc">Edit this Page</a></div>
  </div>
  <div class="content">
<article class="doc">
<h1 class="page">Aggregation</h1>
<div id="preamble">
<div class="sectionbody">
<div class="paragraph">
<p>The <a href="http://docs.mongodb.org/manual/aggregation">aggregation framework</a> in MongoDB allows you to define a series (called a pipeline) of operations (called stages) against the data in a collection.
These pipelines can be used for analytics or they can be used to convert your data from one form to another.
This guide will not go in to the details of how aggregation works, however.
The official MongoDB <a href="http://docs.mongodb.org/manual/aggregation">documentation</a> has extensive tutorials on such details.
Rather, this guide will focus on the Morphia API. The examples shown here are taken from the
<a href="https://github.com/MorphiaOrg/morphia/blob/1.6.x/morphia/src/test/java/dev/morphia/aggregation/AggregationTest.java">tests</a> in Morphia itself.</p>
</div>
<div class="paragraph">
<p>Writing an aggregation pipeline starts just like writing a standard query.
As with querying, we start with the <code>Datastore</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">Iterator&lt;Author&gt; aggregate = datastore.createAggregation(Book.class)
      .group("author", grouping("books", push("title")))
      .out(Author.class, options);</code></pre>
</div>
</div>
<div class="paragraph">
<p><code>createAggregation()</code> takes a <code>Class</code> literal.
This lets Morphia know which collection to perform this aggregation against.
Because of the transformational operations available in the aggregation <a href="http://docs.mongodb.org/manual/core/aggregation-pipeline">pipeline</a>, Morphia can not validate as much as it can with querying so care will need to be taken to ensure document fields actually exist when referencing them in your pipeline.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_the_pipeline"><a class="anchor" href="#_the_pipeline"></a>The Pipeline</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Aggregation operations are comprised of a series stages.
Our example here has only one stage: <code>group()</code>.
This method is the Morphia equivalent of the <a href="http://docs.mongodb.org/manual/reference/operator/aggregation/group/"><code>$group</code></a> operator.
This stage, as the name suggests, groups together documents based on the given field&#8217;s values.
In this example, we are collecting together all the books by author.
The first parameter to <code>group()</code> defines the <code>_id</code> of the resulting documents.
Within this grouping, this pipeline takes the
<code>books</code> fields for each author and extracts the <code>title</code>.
With this grouping of data, we&#8217;re then `push()`ing the titles in to an array
in the final document.  This example is the Morphia equivalent of an
<a href="http://docs.mongodb.org/manual/reference/operator/aggregation/group/#group-title-by-author">example</a> found in the aggregation tutorials.  This
results in a series of documents that look like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-json hljs" data-lang="json">{ "_id" : "Homer", "books" : [ "The Odyssey", "Iliad" ] }
{ "_id" : "Dante", "books" : [ "The Banquet", "Divine Comedy", "Eclogues" ] }</code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_executing_the_pipeline"><a class="anchor" href="#_executing_the_pipeline"></a>Executing the Pipeline</h2>
<div class="sectionbody">
<div class="paragraph">
<p>There are two basic ways to execute an aggregation pipeline:  <code>aggregate()</code> and <code>out()</code>.
These methods are Morphia&#8217;s cues to send the pipeline to MongoDB for execution.
In that regard, both are similar.
In practice, how the results are processed is even very similar.
The differences, however, can have huge implications on the performance of your application.  <code>aggregate()</code> by default will use the 'inline' method for returning the aggregation results.
This approach has the same 16MB limitation that all documents in MongoDB share.
We can changes this behavior using the <a href="http://api.mongodb.org/java/3.0/com/mongodb/AggregationOptions.html"><code>AggregationOptions</code></a>
class.
The <code>options</code> reference we passed to <code>out()</code> also applies to <code>aggregate()</code>.</p>
</div>
<div class="sect2">
<h3 id="_aggregation_options"><a class="anchor" href="#_aggregation_options"></a>Aggregation Options</h3>
<div class="paragraph">
<p>There are a handful options here but there&#8217;s one that deserves some extra attention.
As mentioned, the aggregation pipeline, by default, returns everything "inline" but as of MongoDB 2.6 you can tell the aggregation framework to return a cursor instead.
This is what the value of <a href="http://api.mongodb.org/java/3.0/com/mongodb/AggregationOptions.html#getOutputMode--">AggregationOptions#getOutputMode()</a>
determines.
By setting the output mode to <code>CURSOR</code>, MongoDB can return a result size much larger than 16MB. The options can also be configured to update the batch size or to set the time out threshold after which an aggregation will fail.
It is also possible to tell the aggregation framework to use disk space which allows, among other things, sorting of larger data sets than what can fit in memory on the server.</p>
</div>
</div>
<div class="sect2">
<h3 id="_out"><a class="anchor" href="#_out"></a>$out</h3>
<div class="paragraph">
<p>But this example doesn&#8217;t use <code>aggregate()</code>, of course, it uses <code>out()</code> which gives us access to the <code>$out</code> pipeline stage.
<a href="http://docs.mongodb.org/manual/reference/operator/aggregation/out/"><code>$out</code></a> is a new operator in MongoDB 2.6 that allows the results of a pipeline to be stored in to a named collection.
This collection can not be sharded or a capped collection, however.
This collection, if it does not exist, will be created upon execution of the pipeline.</p>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Any existing data in the collection will be replaced by the output of the aggregation.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Using <code>out()</code> is implicitly asking for the results to be returned via a cursor.
What is happening under the covers is the aggregation framework is writing out to the collection and is done.
Morphia goes one extra step further and executes an implicit <code>find</code> on the output collection and returns a cursor for all the documents in the collection.
In practice, this behaves no differently than setting the output mode to <code>CURSOR</code> with <code>aggregate()</code> and your application need not know the difference.
It does, of course, have an impact on your database and any existing data.
The use of <code>$out</code> and <code>out()</code> can be greatly beneficial in scenarios such as precomputed aggregated results for later retrieval.</p>
</div>
</div>
<div class="sect2">
<h3 id="_typed_results"><a class="anchor" href="#_typed_results"></a>Typed Results</h3>
<div class="paragraph">
<p><code>out()</code> has several variants.
In this example, we&#8217;re passing in <code>Author.class</code> which tells Morphia that we want to map each document returned to an instance of <code>Author</code>.
Because we&#8217;re using <code>out()</code> instead of <code>aggregate()</code>, Morphia will use the mapped collection for
<code>Author</code> as the output collection for the pipeline.
If you&#8217;d like to use an alternate collection but still return a cursor of <code>Author</code>
instances, you can use
<a href="javadoc/dev/morphia/aggregation/AggregationPipeline.html#out-java.lang.String-java.lang.Class-com.mongodb.AggregationOptions-#" class="page"><code>out(String,Class,AggregationOptions)</code></a>(/javadoc/).</p>
</div>
</div>
</div>
</div>
</article>
<aside class="toc sidebar" data-title="Contents" data-levels="2">
  <div class="toc-menu"></div>
</aside>
  </div>
</main>
</div>
<!--
<footer class="footer">
    <p>Copyright (C) 2020-2022
</footer>
-->
<script src="../../_/js/site.js"></script>
<script async src="../../_/js/vendor/highlight.js"></script>
  </body>
</html>
