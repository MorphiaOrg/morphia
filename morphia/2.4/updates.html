<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Untitled :: Morphia Docs</title>
    <meta name="generator" content="Antora 3.1.4">
<link rel="stylesheet" href="../../_/css/site.css">
<link rel="stylesheet" href="../../_/css/morphia.css">

  </head>
  <body class="article">
<header class="header" role="banner">
    <nav class="navbar">
        <div class="navbar-brand">
            <img height="80%" src="../../_/img/logo.png">
        </div>
        <div class="navbar-brand">
            <div class="navbar-item">
                <a href="https://morphia.dev">Morphia</a>
                <span class="separator">//</span>
                <a href="../..">Docs</a>
            </div>
            <button class="navbar-burger" data-target="topbar-nav">
                <span></span>
                <span></span>
                <span></span>
            </button>
        </div>
        <div id="topbar-nav" class="navbar-menu">
            <div class="navbar-end">
                <div class="navbar-item has-dropdown is-hoverable">
                    <div class="navbar-link">Projects</div>
                    <div class="navbar-dropdown">
                        <div class="navbar-item"><strong>Core</strong></div>
                        <a class="navbar-item" href="https://github.com/MorphiaOrg/morphia">Repository</a>
                        <a class="navbar-item" href="https://github.com/MorphiaOrg/morphia/issues">Issue Tracker</a>
                        <hr class="navbar-divider">
                        <div class="navbar-item"><strong>Critter</strong></div>
                        <a class="navbar-item" href="https://github.com/MorphiaOrg/critter">Repository</a>
                        <a class="navbar-item" href="https://github.com/MorphiaOrg/critter/issues">Issue Tracker</a>
                        <!--                        <hr class="navbar-divider">-->
                        <!--                        <a class="navbar-item" href="https://github.com/MorphiaOrg/morphia/blob/master/contributing.adoc">Contributing</a></div>-->
                    </div>
                </div>

                <div class="navbar-item has-dropdown is-hoverable">
                    <div class="navbar-link">Community</div>
                    <div class="navbar-dropdown is-right">
                        <a class="navbar-item" href="https://developer.mongodb.com/community/forums/c/drivers-odms/">Drivers &
                            ODMs chat</a>
                    </div>
                </div>

                <a class="navbar-item" href="https://twitter.com/evanchooly">
                    <span class="icon">
                        <svg aria-hidden="true" data-icon="twitter" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512">
                            <path fill="#57aaee"
                                  d="M459.37 151.716c.325 4.548.325 9.097.325 13.645 0 138.72-105.583 298.558-298.558 298.558-59.452 0-114.68-17.219-161.137-47.106 8.447.974 16.568 1.299 25.34 1.299 49.055 0 94.213-16.568 130.274-44.832-46.132-.975-84.792-31.188-98.112-72.772 6.498.974 12.995 1.624 19.818 1.624 9.421 0 18.843-1.3 27.614-3.573-48.081-9.747-84.143-51.98-84.143-102.985v-1.299c13.969 7.797 30.214 12.67 47.431 13.319-28.264-18.843-46.781-51.005-46.781-87.391 0-19.492 5.197-37.36 14.294-52.954 51.655 63.675 129.3 105.258 216.365 109.807-1.624-7.797-2.599-15.918-2.599-24.04 0-57.828 46.782-104.934 104.934-104.934 30.213 0 57.502 12.67 76.67 33.137 23.715-4.548 46.456-13.32 66.599-25.34-7.798 24.366-24.366 44.833-46.132 57.827 21.117-2.273 41.584-8.122 60.426-16.243-14.292 20.791-32.161 39.308-52.628 54.253z"></path>
                        </svg>
                    </span>
                </a>
            </div>
        </div>
    </nav>
</header>

<div class="body">
<div class="nav-container" data-component="morphia" data-version="2.4">
  <aside class="nav">
    <div class="panels">
<div class="nav-panel-menu is-active" data-panel="menu">
  <nav class="nav-menu">
    <h3 class="title"><a href="index.html">Morphia</a></h3>
<ul class="nav-list">
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="index.html">Getting Started</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="migrating.html">Migrating</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="quicktour.html">Quick Tour</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="preparingFor30.html">Preparing for 3.0</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">Features</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="configuration.html">Configuration</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="configuration-old.html">Configuration (Legacy)</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="kotlin.html">Kotlin</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="mapping.html">Mapping</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="indexing.html">Indexing</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="sharding.html">Sharding</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="queries.html">Querying</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="querying-old.html">Querying (Legacy)</a>
  </li>
  <li class="nav-item is-current-page" data-depth="2">
    <a class="nav-link" href="updates.html">Updating</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="updating-old.html">Updating (Legacy)</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="deletes.html">Deleting</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="aggregations.html">Aggregation</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="textSearches.html">Text Search</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="references.html">References</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="transactions.html">Transactions</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="lifeCycleMethods.html">Life Cycle Methods</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="schemaValidation.html">Schema Validation</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <span class="nav-text"><em>Support</em></span>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="issues-help.html">Issues &amp; Support</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="https://github.com/MorphiaOrg/morphia/">GitHub Repository</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="javadoc/index.html">Javadoc</a>
  </li>
</ul>
  </li>
</ul>
  </nav>
</div>
<div class="nav-panel-explore" data-panel="explore">
  <div class="context">
    <span class="title">Morphia</span>
    <span class="version">2.4</span>
  </div>
  <ul class="components">
    <li class="component">
      <span class="title">Critter</span>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../../critter/4.4/index.html">4.4</a>
        </li>
        <li class="version">
          <a href="../../critter/4.3/index.html">4.3</a>
        </li>
      </ul>
    </li>
    <li class="component">
      <span class="title">Home</span>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../../landing/index.html">landing</a>
        </li>
      </ul>
    </li>
    <li class="component is-current">
      <span class="title">Morphia</span>
      <ul class="versions">
        <li class="version">
          <a href="../3.0/index.html">3.0-SNAPSHOT</a>
        </li>
        <li class="version is-latest">
          <a href="../2.5/index.html">2.5</a>
        </li>
        <li class="version is-current">
          <a href="index.html">2.4</a>
        </li>
        <li class="version">
          <a href="../2.3/index.html">2.3</a>
        </li>
        <li class="version">
          <a href="../1.6/index.html">1.6</a>
        </li>
      </ul>
    </li>
  </ul>
</div>
    </div>
  </aside>
</div>
<main class="article">
<div class="toolbar" role="navigation">
<button class="nav-toggle"></button>
  <a href="../../landing/index.html" class="home-link"></a>
<nav class="breadcrumbs" aria-label="breadcrumbs">
  <ul>
    <li><a href="index.html">Morphia</a></li>
    <li>Features</li>
    <li><a href="updates.html">Updating</a></li>
  </ul>
</nav>
<div class="page-versions">
  <button class="version-menu-toggle" title="Show other versions of page">2.4</button>
  <div class="version-menu">
    <a class="version" href="../3.0/updates.html">3.0-SNAPSHOT</a>
    <a class="version" href="../2.5/updates.html">2.5</a>
    <a class="version is-current" href="updates.html">2.4</a>
    <a class="version" href="../2.3/updates.html">2.3</a>
    <a class="version is-missing" href="../1.6/index.html">1.6</a>
  </div>
</div>
  <div class="edit-this-page"><a href="https://github.com/MorphiaOrg/morphia/edit/2.4.x/docs/modules/ROOT/pages/updates.adoc">Edit this Page</a></div>
  </div>
  <div class="content">
<article class="doc">
<div class="sect1">
<h2 id="_updates"><a class="anchor" href="#_updates"></a>Updates</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Updates in 2.0, are issued using a <code>Query</code> instance . These update operations are executed on the server without fetching any documents across the wire.
Update operations are defined using a set of functions as defined on
<a href="javadoc/dev/morphia/query/updates/UpdateOperators.html">UpdateOperators</a>.
In our examples, we&#8217;ll be using the following model:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@Entity("hotels")
public class Hotel
{
   @Id
   private ObjectId id;

   private String name;
   private int stars;

   @Embedded
   private Address address;

   List&lt;Integer&gt; roomNumbers = new ArrayList&lt;Integer&gt;();

   // ... getters and setters
}

@Embedded
public class Address
{
   private String street;
   private String city;
   private String postalCode;
   private String country;

   // ... getters and setters
}</code></pre>
</div>
</div>
<div class="sect2">
<h3 id="_setunset"><a class="anchor" href="#_setunset"></a>set()/unset()</h3>
<div class="paragraph">
<p>To change the name of the hotel, one would use something like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">datastore
    .find(Hotel.class)
    .update(UpdateOperators.set("name", "Fairmont Chateau Laurier"))
    .execute();</code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>execute()</code> can optionally take <a href="javadoc/dev/morphia/UpdateOptions.html">UpdateOptions</a> if there are any options you might want to apply to your update statement.</p>
</div>
<div class="paragraph">
<p>Embedded documents are updated the same way.
To change the name of the city in the address, one would use something like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">datastore
    .find(Hotel.class)
    .update(UpdateOperators.set("address.city", "Ottawa"))
    execute();</code></pre>
</div>
</div>
<div class="paragraph">
<p>Values can also be removed from documents as shown below:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">datastore
    .find(Hotel.class)
    .update(UpdateOperators.unset("name"))
    execute();</code></pre>
</div>
</div>
<div class="paragraph">
<p>After this update, the name of the hotel would be <code>null</code> when the entity is loaded.</p>
</div>
</div>
<div class="sect2">
<h3 id="_multiple_updates"><a class="anchor" href="#_multiple_updates"></a>Multiple Updates</h3>
<div class="paragraph">
<p>By default, an update operation will only update the first document matching the query.
This behavior can be modified via the optional
<a href="javadoc/dev/morphia/UpdateOptions.html">UpdateOptions</a> parameter on <code>execute()</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">datastore
    .find(Hotel.class)
    .inc("stars")
    .execute(new UpdateOptions()
        .multi(true));</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_upserts"><a class="anchor" href="#_upserts"></a>Upserts</h3>
<div class="paragraph">
<p>In some cases, updates are issued against a query that might not match any documents.
In these cases, it&#8217;s often fine for those updates to simply pass with no effect.
In other cases, it&#8217;s desirable to create an initial document matching the query parameters.
Examples of this might include user high scores, e.g. In cases like this, we have the option to use an upsert:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">datastore
    .find(Hotel.class)
    .filter(gt("stars", 100))
    .update()
    .execute(new UpdateOptions()
                     .upsert(true));

// creates { "_id" : ObjectId("4c60629d2f1200000000161d"), "stars" : 50 }</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_checking_results"><a class="anchor" href="#_checking_results"></a>Checking results</h3>
<div class="paragraph">
<p>In all this one thing we haven&#8217;t really looked at is how to verify the results of an update.
The <code>execute()</code> method returns an instance of
<code>com.mongodb.client.result.UpdateResult</code>.
Using this class, you can get specific numbers from the update operation as well as any generated ID as the result of an upsert.</p>
</div>
</div>
<div class="sect2">
<h3 id="_returning_the_updated_entity"><a class="anchor" href="#_returning_the_updated_entity"></a>Returning the updated entity</h3>
<div class="paragraph">
<p>There are times when a document needs to be updated and also fetched from the database.
In the server documentation, this is referred to as <a href="http://docs.mongodb.org/manual/reference/method/db.collection.findAndModify/">findAndModify</a>.
In Morphia, this functionality is exposed through the
<a href="javadoc/dev/morphia/query/Query.html#modify(dev.morphia.query.updates.UpdateOperator,dev.morphia.query.updates.UpdateOperator...)">Query#modify()</a>
method. With this method, you can choose to return the updated entity in either the
state before or after the update. The default is to return the entity in the <em>before</em> state.
This can be changed by passing in a <code>ModifyOptions</code> reference to the operation:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">datastore
    .find(Hotel.class)
    .modify(UpdateOperators.set("address.city", "Ottawa"))
    execute(new ModifyOptions()
        .returnDocument(ReturnDocument.AFTER));</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_merges"><a class="anchor" href="#_merges"></a>Merges</h3>
<div class="paragraph">
<p>A specialized form of an update is the <a href="javadoc/dev/morphia/Datastore.html#merge(T)">merge()</a> operation.
A common case in scenarios where multiple subsystems or applications share a database is where one part of the system might only have part of a larger entity. e.g., a
<a href="https://en.wikipedia.org/wiki/Data_transfer_object">DTO</a> might only have a subset of an entity necessary to perform the duties of that particular service.
Updating the database with the partial entities can be problematic because it forces the application developer to inspect an entity&#8217;s state and manually generate the correct set of update statements.
Morphia 2.0 introduced the <code>merge()</code> method to help cover this case.
Using <code>merge()</code>, a specific set of <code>$set</code> updates are issued to only save fields as defined on the DTO type itself (which, of course, must be annotated with <code>@Entity</code> like any other Morphia type).</p>
</div>
<div class="paragraph">
<p>This is useful but limited.
What happens to any null fields and empty Lists?
Using <code>MapperOptions</code>, Morphia can be configured to not persist those fields such that they never end up in the database.
In the above scenario, however, Morphia is only issuing a <code>$set</code> for the fields that should be persisted which leaves potentially outdated information in the database. (e.g., say a process removes the final item from a List in memory.  <code>merge()</code> would actually <strong>leave</strong> that last item in the database because an update would not be issued for that empty List.) In 2.2, a new value is added to the optional <a href="javadoc/dev/morphia/InsertOneOptions.html">InsertOneOptions</a> to account for this.</p>
</div>
<div class="paragraph">
<p>Setting <a href="javadoc/dev/morphia/InsertOneOptions.html#unsetMissing(boolean)">unsetMissing</a> to true, any property defined on an entity
that isn&#8217;t getting updated via <code>$set</code> will have a <code>$unset</code> operator defined.
This will result in null properties and empty Lists getting removed from documents in the database so that they will reflect the current state in memory.</p>
</div>
<div class="paragraph">
<p>Regardless of whether this value is set, <code>merge()</code> will issue a <code>find()</code> for that entity and will return the updated form from the database.
Without using <code>unsetMissing()</code>, this is useful for merging the in memory state with what&#8217;s in the database.
With this value set, the two should be identical, of course.</p>
</div>
</div>
</div>
</div>
</article>
<aside class="toc sidebar" data-title="Contents" data-levels="2">
  <div class="toc-menu"></div>
</aside>
  </div>
</main>
</div>
<!--
<footer class="footer">
    <p>Copyright (C) 2020-2025
</footer>
-->
<script src="../../_/js/site.js"></script>
<script async src="../../_/js/vendor/highlight.js"></script>
  </body>
</html>
